<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bitácora CEFI | FQ</title>
        <link
            rel="icon"
            type="image/png"
            href="https://example.com/favicon.png"
        />

        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
            crossorigin="anonymous"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
        />
    </head>

    <body>
        <div class="container py-5">
            <!-- FORM SECTION -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Registro de Bitácora</h4>
                </div>
                <div class="card-body">
                    <form>
                        <div class="row g-3">
                            <!-- Nombre -->
                            <div class="col-md-4">
                                <label for="name" class="form-label"
                                    >Nombre
                                    <span class="text-danger">*</span></label
                                >
                                <div class="input-group">
                                    <span class="input-group-text"
                                        ><i class="bi bi-person-fill"></i
                                    ></span>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="name"
                                        placeholder="Nombre"
                                    />
                                </div>
                            </div>

                            <!-- Laboratorio -->
                            <div class="col-md-4">
                                <label for="lab" class="form-label"
                                    >Laboratorio
                                    <span class="text-danger">*</span></label
                                >
                                <div class="input-group">
                                    <span class="input-group-text"
                                        ><i class="bi bi-building"></i
                                    ></span>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="lab"
                                        placeholder="Laboratorio"
                                    />
                                </div>
                            </div>

                            <!-- Equipo -->
                            <div class="col-md-4">
                                <label for="equipment" class="form-label"
                                    >Equipo
                                    <span class="text-danger">*</span></label
                                >
                                <div class="input-group">
                                    <span class="input-group-text"
                                        ><i class="bi bi-tools"></i
                                    ></span>
                                    <select
                                        class="form-select"
                                        id="equipment"
                                        onchange="equipmentComments()"
                                    >
                                        <option selected disabled value="">
                                            Seleccione un equipo
                                        </option>
                                        <option value="HPLC">HPLC</option>
                                        <option value="UHPLC">UHPLC</option>
                                        <option value="UHPLC-MS">
                                            UHPLC-MS
                                        </option>
                                        <option value="GC">GC</option>
                                        <option value="UV">UV</option>
                                        <option value="FTIR">FTIR</option>
                                        <option value="NMR">NMR</option>
                                        <option value="TOC">TOC</option>
                                        <option value="EXRF">EXRF</option>
                                        <option value="Cuba electroforesis">
                                            Cuba electroforesis
                                        </option>
                                        <option value="Documentador de geles">
                                            Documentador de geles
                                        </option>
                                        <option value="Transiluminador">
                                            Transiluminador
                                        </option>
                                        <option value="Transiluminador UV">
                                            Transiluminador UV
                                        </option>
                                        <option value="Potenciostato">
                                            Potenciostato
                                        </option>
                                        <option value="Lector de microplacas">
                                            Lector de microplacas
                                        </option>
                                        <option value="PCR">PCR</option>
                                        <option value="Titulador automático">
                                            Titulador automático
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Fecha -->
                            <div class="col-md-4">
                                <label for="date" class="form-label"
                                    >Fecha
                                    <span class="text-danger">*</span></label
                                >
                                <div class="input-group">
                                    <span class="input-group-text"
                                        ><i class="bi bi-calendar"></i
                                    ></span>
                                    <input
                                        type="date"
                                        class="form-control"
                                        id="date"
                                        placeholder="Fecha"
                                    />
                                </div>
                            </div>

                            <!-- Hora Inicio -->
                            <div class="col-md-4">
                                <label for="startTime" class="form-label"
                                    >Hora Inicio
                                    <span class="text-danger">*</span></label
                                >
                                <div class="input-group">
                                    <span class="input-group-text"
                                        ><i class="bi bi-clock"></i
                                    ></span>
                                    <input
                                        type="time"
                                        class="form-control"
                                        id="startTime"
                                        placeholder="Hora Inicio"
                                    />
                                </div>
                            </div>

                            <!-- Hora Fin -->
                            <div class="col-md-4">
                                <label for="endTime" class="form-label"
                                    >Hora Fin</label
                                >
                                <div class="input-group">
                                    <span class="input-group-text"
                                        ><i class="bi bi-clock"></i
                                    ></span>
                                    <input
                                        type="time"
                                        class="form-control"
                                        id="endTime"
                                        placeholder="Hora Fin"
                                    />
                                </div>
                            </div>
                        </div>

                        <!-- CHECKBOXES -->
                        <div class="row mt-4 text-center">
                            <div
                                class="col-md-6 d-flex justify-content-center align-items-center"
                            >
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        id="recived"
                                    />
                                    <label
                                        class="form-check-label ms-2"
                                        for="recived"
                                        >Recibió en buen estado el
                                        equipo?</label
                                    >
                                </div>
                            </div>
                            <div
                                class="col-md-6 d-flex justify-content-center align-items-center"
                            >
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        id="returned"
                                    />
                                    <label
                                        class="form-check-label ms-2"
                                        for="returned"
                                        >Devolvió en buen estado el
                                        equipo?</label
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- COMMENTS -->
                        <div class="mt-3">
                            <label
                                for="comments"
                                id="required-comments"
                                class="form-label"
                                >Comentarios</label
                            >
                            <div class="input-group">
                                <span class="input-group-text"
                                    ><i class="bi bi-chat-dots"></i
                                ></span>
                                <textarea
                                    class="form-control"
                                    id="comments"
                                    placeholder="Comentarios"
                                    style="height: 100px"
                                ></textarea>
                            </div>
                        </div>

                        <!-- SUBMIT BUTTON -->
                        <div class="d-flex justify-content-center mt-4 gap-2">
                            <button
                                type="button"
                                class="btn btn-dark btn-lg"
                                onclick="formVerification()"
                            >
                                <i class="bi bi-check-circle me-2"></i>Ingresar
                                Datos
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- LOG SECTION -->
            <div></div>

            <!-- TABLE SECTION -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Listado de Registros</h4>
                </div>
                <div class="card-body">
                    <div
                        class="d-flex justify-content-center align-items-center gap-2 mb-3"
                    >
                        <div class="input-group" style="max-width: 400px">
                            <span class="input-group-text"
                                ><i class="bi bi-tools"></i
                            ></span>
                            <select class="form-select" id="slt-equipment">
                                <option selected disabled value="">
                                    Seleccione un equipo a filtrar
                                </option>
                                <option value="HPLC">HPLC</option>
                                <option value="UHPLC">UHPLC</option>
                                <option value="UHPLC-MS">UHPLC-MS</option>
                                <option value="GC">GC</option>
                                <option value="UV">UV</option>
                                <option value="FTIR">FTIR</option>
                                <option value="NMR">NMR</option>
                                <option value="TOC">TOC</option>
                                <option value="EXRF">EXRF</option>
                                <option value="Cuba electroforesis">
                                    Cuba electroforesis
                                </option>
                                <option value="Documentador de geles">
                                    Documentador de geles
                                </option>
                                <option value="Transiluminador">
                                    Transiluminador
                                </option>
                                <option value="Transiluminador UV">
                                    Transiluminador UV
                                </option>
                                <option value="Potenciostato">
                                    Potenciostato
                                </option>
                                <option value="Lector de microplacas">
                                    Lector de microplacas
                                </option>
                                <option value="PCR">PCR</option>
                                <option value="Titulador automático">
                                    Titulador automático
                                </option>
                            </select>
                        </div>
                        <button
                            type="button"
                            class="btn btn-secondary"
                            onclick="loadLogsTable()"
                        >
                            <i class="bi bi-funnel-fill me-2"></i>Filtrar
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table
                            class="table table-striped table-hover align-middle"
                        >
                            <thead class="table-dark">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Laboratorio</th>
                                    <th>Equipo</th>
                                    <th>Fechas/Hora</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tbody-logs"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const equipmentComments = () => {
                let selected = document.getElementById("equipment").value;
                let title = document.getElementById("required-comments");
                if (
                    selected == "HPLC" ||
                    selected == "UHPLC" ||
                    selected == "UHPLC-MS"
                )
                    title.innerHTML =
                        'Comentarios<strong class="text-danger">*</strong>';
                else title.innerHTML = "Comentarios";
            };

            const formVerification = () => {
                let name = document.getElementById("name").value;
                let lab = document.getElementById("lab").value;
                let equipment = document.getElementById("equipment").value;
                let date = document.getElementById("date").value;
                let startTime = document.getElementById("startTime").value;
                let endTime = document.getElementById("endTime").value;
                let recived = document.getElementById("recived").checked;
                let returned = document.getElementById("returned").checked;
                let comments = document.getElementById("comments").value;

                console.log(date);
                console.log(startTime);

                let form = {
                    // Strings
                    name: name,
                    lab: lab,
                    equipment: equipment,
                    comments: comments,

                    // Numbers
                    startDateTime: new Date(`${date}T${startTime}`).getTime(),
                    endDateTime: endTime
                        ? new Date(`${date}T${endTime}`).getTime()
                        : null,

                    // Booleans
                    received: recived,
                    returned: returned,
                };

                verifyMandatoryFields(form)
                    ? submitForm(form)
                    : alert("Ingreso incorrecto, revise campos");
            };

            const cleanFieldsOnSuccess = () => {
                document.getElementById("name").value = "";
                document.getElementById("lab").value = "";
                document.getElementById("equipment").value = "";
                document.getElementById("date").value = "";
                document.getElementById("startTime").value = "";
                document.getElementById("endTime").value = "";
                document.getElementById("recived").checked = false;
                document.getElementById("returned").checked = false;
                document.getElementById("comments").value = "";
            };

            const verifyMandatoryFields = (form) => {
                if (
                    form.startDateTime == "Invalid Date" ||
                    isNaN(form.startDateTime)
                ) {
                    alert("Ingrese una fecha y hora de inicio válidas");
                    return false;
                }

                if (form.equipment == "") {
                    alert("Seleccione un equipo");
                    return false;
                }
                if (form.name == "") {
                    alert("Ingrese su nombre");
                    return false;
                }
                if (form.lab == "") {
                    alert("Ingrese un laboratorio");
                    return false;
                }
                if (
                    form.equipment == "HPLC" ||
                    form.equipment == "UHPLC" ||
                    form.equipment == "UHPLC-MS"
                ) {
                    if (form.comments == "") {
                        alert("Debe ingresar un comentario");
                        return false;
                    }
                }
                return true;
            };

            //---------------------------------------------------------------------------------------- //
            // methods
            //---------------------------------------------------------------------------------------- //

            const formatedDate = (date) => {
                return `${date[2]}/${date[1]}/${date[0]}`;
            };

            const error = (data) => {
                alert("Error al ingresar");
                console.log(data);
            };

            // -------------------------------------------------------------------------------------- //
            // Log's table
            // -------------------------------------------------------------------------------------- //

            const loadLogsTable = async () => {
                let table = document.getElementById("tbody-logs");
                let equipment = document.getElementById("slt-equipment").value;
                const response = await fetch(
                    `/bitacora/records/machine?type=${equipment}`,
                    {
                        method: "GET",
                    },
                )
                    .then((response) => response.json())
                    .then((data) => {
                        console.log(data);
                        return data;
                    });
                table.innerHTML = "";
                if (response.count != 0) {
                    for (let i = 0; i < response.length; i++) {
                        date = new Date(response[i].StartDateTime)
                            .toLocaleDateString()
                            .split("/");
                        table.innerHTML += `
            	<tr>

            		<td>${response[i].Name}</td>
            		<td>${response[i].Lab}</td>
            		<td>${response[i].Equipment}</td>
            		<td>${date[1]}/${date[0]}/${date[2]}</td>
            		<td><a href="/bitacora/records/open?id=${response[i].ID}" class="details btn btn-dark btn-lg">Detalles</a></td>
            	</tr>
            `;
                    }
                }
            };
        </script>
    </body>
    <style>
        body {
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
        }

        .card {
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: #003366;
            color: #ffffff;
        }

        .btn-dark {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .btn-dark:hover {
            background-color: #003d80;
            border-color: #003366;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .table-dark {
            background-color: #003366;
            color: #ffffff;
        }

        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: #e9ecef;
        }

        .table-hover tbody tr:hover {
            background-color: #d0e1f9;
        }

        .form-label,
        .form-check-label {
            font-weight: 500;
            color: #003366;
        }

        .input-group-text {
            background-color: #e9ecef;
        }

        .details {
            font-size: 15px !important;
        }
    </style>
</html>
